<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Initialize Comment Counts</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-top: 0;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
        }

        button:hover {
            background: #1976d2;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            margin-top: 20px;
        }

        .log-entry {
            margin: 5px 0;
        }

        .log-success {
            color: #4caf50;
        }

        .log-error {
            color: #f44336;
        }

        .log-info {
            color: #2196f3;
        }

        .log-warning {
            color: #ff9800;
        }

        .hidden {
            display: none;
        }

        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            flex: 1;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2196f3;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üöÄ Initialize Comment Counts</h1>

        <div class="info-box">
            <strong>‚ÑπÔ∏è What this does:</strong>
            <p>This tool will create comment count documents in Firebase Firestore for all your blog posts, setting the
                initial count to 0. The sync function will then update these counts from Disqus.</p>
        </div>

        <div class="warning-box">
            <strong>‚ö†Ô∏è Before you start:</strong>
            <ul>
                <li>Make sure you've deployed the Firestore rules</li>
                <li>Ensure Firebase is configured in your app</li>
                <li>Have your post slugs ready</li>
            </ul>
        </div>

        <h3>Step 1: Enter Post Slugs</h3>
        <p>Enter one post slug per line:</p>
        <textarea id="postSlugs" placeholder="about-sky-stars-orbits
another-post-slug
yet-another-post"></textarea>

        <div style="margin: 20px 0;">
            <button onclick="loadFromTina()">üì• Load from TinaCMS</button>
            <button onclick="startInitialization()">‚ñ∂Ô∏è Initialize Comment Counts</button>
            <button onclick="verifySetup()">‚úÖ Verify Setup</button>
        </div>

        <div id="stats" class="stats hidden">
            <div class="stat-card">
                <div class="stat-value" id="successCount">0</div>
                <div class="stat-label">Initialized</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="errorCount">0</div>
                <div class="stat-label">Errors</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">Total</div>
            </div>
        </div>

        <div id="log" class="log hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, serverTimestamp, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Your Firebase config - update with your actual config
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        let db;
        let successCount = 0;
        let errorCount = 0;
        let totalCount = 0;

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            log('‚úÖ Firebase initialized', 'success');
        } catch (error) {
            log('‚ùå Firebase initialization error: ' + error.message, 'error');
        }

        window.loadFromTina = async function () {
            log('üì• Attempting to load posts from TinaCMS...', 'info');

            try {
                // Try to get posts from the global context
                if (window.tinaData && window.tinaData.posts) {
                    const slugs = window.tinaData.posts.map(p => p.slug).join('\n');
                    document.getElementById('postSlugs').value = slugs;
                    log(`‚úÖ Loaded ${window.tinaData.posts.length} posts from TinaCMS`, 'success');
                } else {
                    log('‚ö†Ô∏è TinaCMS data not found. Please enter slugs manually.', 'warning');
                }
            } catch (error) {
                log('‚ùå Error loading from TinaCMS: ' + error.message, 'error');
            }
        }

        window.startInitialization = async function () {
            const textarea = document.getElementById('postSlugs');
            const slugs = textarea.value.split('\n')
                .map(s => s.trim())
                .filter(s => s.length > 0);

            if (slugs.length === 0) {
                log('‚ùå No post slugs entered!', 'error');
                return;
            }

            // Reset counters
            successCount = 0;
            errorCount = 0;
            totalCount = slugs.length;

            // Show stats and log
            document.getElementById('stats').classList.remove('hidden');
            document.getElementById('log').classList.remove('hidden');
            updateStats();

            log(`üöÄ Starting initialization for ${slugs.length} posts...`, 'info');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

            for (const slug of slugs) {
                try {
                    const docRef = doc(db, 'commentCounts', slug);
                    await setDoc(docRef, {
                        count: 0,
                        lastUpdated: serverTimestamp(),
                        postSlug: slug,
                        initialized: true
                    }, { merge: true });

                    successCount++;
                    updateStats();
                    log(`‚úÖ ${successCount}. Initialized: ${slug}`, 'success');

                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 100));
                } catch (error) {
                    errorCount++;
                    updateStats();
                    log(`‚ùå Error initializing ${slug}: ${error.message}`, 'error');
                }
            }

            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            log('üéâ Initialization complete!', 'success');
            log(`   ‚úÖ Success: ${successCount}`, 'success');
            log(`   ‚ùå Errors: ${errorCount}`, errorCount > 0 ? 'error' : 'success');
            log(`   üìä Total: ${totalCount}`, 'info');
            log('', 'info');
            log('üí° Next steps:', 'info');
            log('   1. Deploy sync function: firebase deploy --only functions', 'info');
            log('   2. Wait 5 minutes for first sync', 'info');
            log('   3. Check Firebase Console > Firestore > commentCounts', 'info');
        }

        window.verifySetup = async function () {
            log('üîç Verifying setup...', 'info');

            try {
                const querySnapshot = await getDocs(collection(db, 'commentCounts'));
                log(`‚úÖ Found ${querySnapshot.size} documents in commentCounts collection`, 'success');

                if (querySnapshot.size > 0) {
                    log('', 'info');
                    log('üìä Sample documents:', 'info');
                    querySnapshot.docs.slice(0, 5).forEach((doc, index) => {
                        const data = doc.data();
                        log(`   ${index + 1}. ${doc.id}: ${data.count} comments`, 'info');
                    });
                }

                log('', 'info');
                log('‚úÖ Setup verified successfully!', 'success');
            } catch (error) {
                log('‚ùå Verification error: ' + error.message, 'error');
                log('', 'info');
                log('üí° Troubleshooting:', 'warning');
                log('   1. Check Firebase config above', 'info');
                log('   2. Deploy Firestore rules', 'info');
                log('   3. Check browser console for detailed errors', 'info');
            }
        }

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = message;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStats() {
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('errorCount').textContent = errorCount;
            document.getElementById('totalCount').textContent = totalCount;
        }
    </script>
</body>

</html>